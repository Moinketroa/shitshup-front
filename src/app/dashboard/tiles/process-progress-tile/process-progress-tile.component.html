<mat-card class="process-progress-card">
    <mat-card-header>
        <mat-card-title class="process-progress-card--title">
            Process Progress Status
        </mat-card-title>
        <mat-card-subtitle>You can track here the progress of your videos' processing</mat-card-subtitle>
    </mat-card-header>

    <mat-card-content class="process-progress-card--content">
        <ng-container [ngTemplateOutlet]="treeTable"></ng-container>
    </mat-card-content>
</mat-card>

<ng-template #treeTable>
    <p-treeTable *ngIf="processTreeNodes" [value]="processTreeNodes"
                 [scrollable]="true" scrollHeight="flex"
                 sortField="createdAt" [sortOrder]="1"
                 styleClass="process-progress-tree-table">
        <ng-template pTemplate="header">
            <tr>
                <th class="process-progress-tree-table--cell">Name</th>
                <th [ttSortableColumn]="'createdAt'"
                    class="process-progress-tree-table--cell process-progress-tree-table--create-date--header">
                    Created at
                    <p-treeTableSortIcon [field]="'createdAt'"></p-treeTableSortIcon>
                </th>
                <th class="process-progress-tree-table--cell process-progress-tree-table--progress--header">
                    Progress
                </th>
                <th class="process-progress-tree-table--cell process-progress-tree-table--status--header">
                    Status
                </th>
                <th class="process-progress-tree-table--cell process-progress-tree-table--actions--header">
                    Actions
                </th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-rowNode let-rowData="rowData">
            <tr [ttRow]="rowNode" *ngIf="rowNode.node.type === ProcessNodeType.ROOT">
                <td class="process-progress-tree-table--cell">
                    <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                    {{ rowNode.node.label }}
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--create-date--cell">
                    {{ DateTime.fromISO(rowData.createdAt).toLocaleString(DateTime.DATETIME_SHORT_WITH_SECONDS) }}
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--progress--cell">
                    <mat-progress-bar mode="determinate" color="accent" [value]="rowData.progress * 100">
                    </mat-progress-bar>
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--status--cell">
                    <ng-container [ngTemplateOutlet]="statusIcon"
                                  [ngTemplateOutletContext]="{
                                    progress: rowData.progress,
                                    hasFailed: rowData.hasFailed,
                                  }">
                    </ng-container>
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--actions--cell">
                    <button
                        [disabled]="!(rowData.hasFailed || rowData.progress >= 1)"
                        mat-mini-fab matTooltip="Delete" color="warn"
                        aria-label="Delete">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </tr>

            <tr [ttRow]="rowNode" *ngIf="rowNode.node.type === ProcessNodeType.TRACK">
                <td class="process-progress-tree-table--cell">
                    <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                    {{ rowNode.node.label }}
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--create-date--cell">
                    {{ DateTime.fromISO(rowData.createdAt).toLocaleString(DateTime.DATETIME_SHORT_WITH_SECONDS) }}
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--progress--cell">
                    <mat-progress-bar mode="determinate" color="accent" [value]="rowData.progress * 100">
                    </mat-progress-bar>
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--status--cell">
                    <ng-container [ngTemplateOutlet]="statusIcon"
                                  [ngTemplateOutletContext]="{
                                    progress: rowData.progress,
                                    hasFailed: rowData.hasFailed,
                                  }">
                    </ng-container>
                </td>
                <td class="process-progress-tree-table--cell process-progress-tree-table--actions--cell">
                    <button
                        [disabled]="!(rowData.hasFailed || rowData.progress >= 1)"
                        mat-mini-fab matTooltip="Delete" color="warn"
                        aria-label="Delete">
                        <mat-icon>delete</mat-icon>
                    </button>
                </td>
            </tr>

            <tr [ttRow]="rowNode" *ngIf="rowNode.node.type === ProcessNodeType.STEPS">
                <td class="process-progress-tree-table--cell" [colSpan]="5">
                    <shitshup-process-steps-progress [processStepsData]="rowData"></shitshup-process-steps-progress>
                </td>
            </tr>
        </ng-template>
    </p-treeTable>
</ng-template>

<ng-template #statusIcon let-progress="progress" let-hasFailed="hasFailed">
    <ng-template [ngIf]="hasFailed" [ngIfElse]="nominalStatus">
        <mat-icon class="fail-icon">close</mat-icon>
    </ng-template>

    <ng-template #nominalStatus>
        <ng-template [ngIf]="progress >= 1" [ngIfElse]="inProgress">
            <mat-icon class="done-icon">done</mat-icon>
        </ng-template>

        <ng-template #inProgress>
            <mat-icon class="in-progress-icon">pending</mat-icon>
        </ng-template>
    </ng-template>
</ng-template>
